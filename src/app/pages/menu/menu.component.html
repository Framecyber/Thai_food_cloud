<div class="menu-container">
  <div class="header-container">
    <h2 id="pageTitle">‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≠‡∏á‡πÄ‡πÄ‡∏ö‡∏á‡∏Ñ‡πå üçΩÔ∏è</h2>

    <div class="header-right">
      <div class="search-container">
        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π..." [(ngModel)]="searchTerm" (input)="applyFilters()"
               aria-label="Search menu items" />
        <i class="search-icon" aria-hidden="true">üîç</i>
      </div>

      <button class="cart-button" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" (click)="openCart()">
        üõí
        <span *ngIf="distinctItemsCount > 0" class="cart-badge" aria-live="polite">{{ distinctItemsCount }}</span>
      </button>
    </div>
  </div>

  <div class="menu-filters" aria-labelledby="pageTitle" role="tablist">
    <button role="tab" (click)="filterMenu('all')" [class.active]="selectedCategory === 'all'">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button role="tab" (click)="filterMenu('appetizer')" [class.active]="selectedCategory === 'appetizer'">‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</button>
    <button role="tab" (click)="filterMenu('main-course')" [class.active]="selectedCategory === 'main-course'">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å</button>
    <button role="tab" (click)="filterMenu('dessert')" [class.active]="selectedCategory === 'dessert'">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</button>
    <button role="tab" (click)="filterMenu('drink')" [class.active]="selectedCategory === 'drink'">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</button>
  </div>

  <div class="layout">
    <div class="menu-grid">
      <ng-container *ngIf="filteredMenuItems.length > 0; else noItems">
        <div class="menu-card" *ngFor="let item of filteredMenuItems">
          <div class="media-wrap">
            <img [src]="item.image || fallbackImg" [alt]="item.name"
                 class="menu-item-image" loading="lazy" (error)="onImgError($event)" />
          </div>

          <div class="card-body">
            <h3 class="title">{{ item.name }}</h3>
            <p class="description">{{ item.description }}</p>

            <div class="price-row">
              <span class="price">{{ item.price | currency:'THB':'symbol':'1.2-2' }}</span>

              <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö type + class) -->
              <button type="button" class="add-btn"
                      (click)="addToOrder(item)"
                      [attr.aria-label]="'‡πÄ‡∏û‡∏¥‡πà‡∏° ' + item.name + ' ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'">
                <span class="btn-icon" aria-hidden="true">Ôºã</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
              </button>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #noItems>
        <p class="no-items-message">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>
      </ng-template>
    </div>
  </div>

  <!-- Drawer -->
  <div class="cart-overlay" *ngIf="showCart" (click)="closeCart()" aria-hidden="true"></div>
  <aside class="cart-drawer" *ngIf="showCart" role="dialog" aria-modal="true" aria-labelledby="cartTitle"
         (keydown.escape)="closeCart()" tabindex="-1" #cartDialog>
    <header class="cart-header">
      <h3 id="cartTitle">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h3>
      <button class="icon-btn" (click)="closeCart()" aria-label="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á" #cartCloseBtn>‚úï</button>
    </header>

    <section class="cart-body" *ngIf="order.length > 0; else emptyCart">
      <div class="line" *ngFor="let l of order">
        <div class="line-name">{{ l.item.name }}</div>
        <div class="line-actions">
          <button type="button" (click)="decreaseQty(l)" aria-label="‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">‚àí</button>
          <span class="qty" aria-live="polite">{{ l.qty }}</span>
          <button type="button" (click)="increaseQty(l)" aria-label="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">Ôºã</button>
        </div>
        <div class="line-total">{{ (l.item.price * l.qty) | currency:'THB':'symbol':'1.2-2' }}</div>
        <button type="button" class="remove" (click)="removeLine(l)"
                [attr.aria-label]="'‡∏ô‡∏≥ ' + l.item.name + ' ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤'">‡∏•‡∏ö</button>
      </div>

      <hr>

      <div class="collapsible">
        <button type="button" class="collapse-toggle" (click)="toggleOptions()"
                [attr.aria-expanded]="showOptions" aria-controls="optsPanel">
          ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î / Service / VAT)
          <span class="chev" [class.up]="showOptions">‚ñæ</span>
        </button>

        <div id="optsPanel" class="options" *ngIf="showOptions">
          <label>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô %:
            <input type="number" min="0" step="0.01" [(ngModel)]="discountPct" (input)="syncRates()">
          </label>
          <label>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó):
            <input type="number" min="0" step="0.01" [(ngModel)]="discountFixed" (input)="syncRates()">
          </label>
          <label>Service charge (%):
            <input type="number" min="0" step="0.01" [(ngModel)]="serviceChargePct" (input)="syncRates()">
          </label>
          <label>VAT (%):
            <input type="number" min="0" step="0.01" [(ngModel)]="vatPct" (input)="syncRates()">
          </label>
        </div>
      </div>

      <div class="collapsible" *ngIf="receipt">
        <button type="button" class="collapse-toggle" (click)="toggleTotals()"
                [attr.aria-expanded]="showTotals" aria-controls="totalsPanel">
          ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
          <span class="chev" [class.up]="showTotals">‚ñæ</span>
        </button>

        <div id="totalsPanel" class="totals" *ngIf="showTotals">
          <div class="row"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î</span><span>{{ receipt.subtotal | currency:'THB':'symbol':'1.2-2' }}</span></div>
          <div class="row"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span><span>-{{ receipt.discount | currency:'THB':'symbol':'1.2-2' }}</span></div>
          <div class="row"><span>‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span><span>{{ receipt.serviceCharge | currency:'THB':'symbol':'1.2-2' }}</span></div>
          <div class="row"><span>VAT</span><span>{{ receipt.vat | currency:'THB':'symbol':'1.2-2' }}</span></div>
          <div class="row grand" aria-live="polite"><span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span>{{ receipt.grandTotal | currency:'THB':'symbol':'1.2-2' }}</span></div>
        </div>
      </div>

      <div class="actions">
        <button type="button" (click)="confirmOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
        <button type="button" (click)="printReceipt()">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
        <button type="button" class="secondary" (click)="clearOrder()">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>
    </section>

    <ng-template #emptyCart>
      <div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
    </ng-template>
  </aside>
</div>

<!-- ‡πÇ‡∏°‡∏î‡∏±‡∏• ‚Äú‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô‚Äù + ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå -->
<div *ngIf="showThanks"
     style="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;"></div>

<div *ngIf="showThanks"
     role="dialog" aria-modal="true" aria-labelledby="thanksTitle"
     style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1001;">
  <div style="background:#fff;padding:20px 24px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:min(90vw,420px);text-align:center;">
    <h3 id="thanksTitle" style="margin:0 0 8px;">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô</h3>
    <p style="margin:0 0 4px;">Order: <strong>{{ orderId }}</strong></p>
    <p style="margin:0 0 16px;">‡πÄ‡∏£‡∏≤‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
    <button type="button" (click)="showThanks=false">OK</button>
  </div>
</div>
